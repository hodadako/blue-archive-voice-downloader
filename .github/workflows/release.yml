name: build-release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

jobs:
  update_release_draft:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: release-drafter/release-drafter@v6
        with:
          config-name: release-drafter.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    if: startsWith(github.ref, 'refs/tags/v')
    name: Build (${{ matrix.os }} / ${{ matrix.arch }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            os_name: macOS
            arch: x64
            npm_script: build:mac:x64
            artifact_name: macOS-x64-build
            package_ext: .dmg
          - os: macos-latest
            os_name: macOS
            arch: arm64
            npm_script: build:mac:arm64
            artifact_name: macOS-arm64-build
            package_ext: .dmg
          - os: windows-latest
            os_name: Windows
            arch: x64
            npm_script: build:win:x64
            artifact_name: Windows-x64-build
            package_ext: .exe
          - os: windows-latest
            os_name: Windows
            arch: arm64
            npm_script: build:win:arm64
            artifact_name: Windows-arm64-build
            package_ext: .exe
          - os: ubuntu-latest
            os_name: Linux
            arch: x64
            npm_script: build:linux:x64
            artifact_name: Linux-x64-build
            package_ext: .AppImage
          - os: ubuntu-latest
            os_name: Linux
            arch: arm64
            npm_script: build:linux:arm64
            artifact_name: Linux-arm64-build
            package_ext: .AppImage
    runs-on: ${{ matrix.os }}

    env:
      CSC_IDENTITY_AUTO_DISCOVERY: false

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build artifacts
        run: npm run ${{ matrix.npm_script }} -- --publish never

      - name: Normalize release artifact name
        shell: bash
        run: |
          shopt -s nullglob
          ext='${{ matrix.package_ext }}'
          candidates=(dist/*"$ext")
          selected=''
          for file in "${candidates[@]}"; do
            name="$(basename "$file")"
            if [[ "$name" == *".blockmap" ]]; then
              continue
            fi
            if [[ "$name" == *"Setup"*".exe" ]]; then
              continue
            fi
            selected="$file"
            break
          done

          if [[ -z "$selected" ]]; then
            echo "No package found for ${{ matrix.os_name }} / ${{ matrix.arch }} ($ext)"
            exit 1
          fi

          normalized="dist/BlueArchiveVoiceDownloader-${{ matrix.os_name }}-${{ matrix.arch }}$ext"
          cp "$selected" "$normalized"
          echo "normalized=$normalized" >> "$GITHUB_OUTPUT"
        id: normalize

      - name: Upload artifacts (installers only)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ steps.normalize.outputs.normalized }}
          if-no-files-found: error

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Collect release files
        run: |
          mkdir -p release-files
          find release-assets -type f \
            \( -name "BlueArchiveVoiceDownloader-macOS-*.dmg" -o -name "BlueArchiveVoiceDownloader-Windows-*.exe" -o -name "BlueArchiveVoiceDownloader-Linux-*.AppImage" \) \
            -exec cp {} release-files/ \;

          count=$(find release-files -type f | wc -l | tr -d ' ')
          if [[ "$count" -ne 6 ]]; then
            echo "Expected 6 release files (OS x ARCH), got $count"
            find release-files -type f -maxdepth 1 -print
            exit 1
          fi

      - name: Resolve release-drafter notes
        id: drafter_notes
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');
            const releases = await github.paginate(github.rest.repos.listReleases, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            const draftByTag = releases.find((r) => r.draft && r.tag_name === tag);
            const picked = draftByTag || null;

            if (!picked) {
              core.info(`No tag-matched draft release from release-drafter for ${tag} was found.`);
              core.setOutput('has_draft', 'false');
              core.setOutput('release_name', `Release ${tag}`);
              core.setOutput('release_body', '');
              return;
            }

            core.info(`Using draft release notes from: ${picked.name || picked.tag_name}`);
            core.setOutput('has_draft', 'true');
            core.setOutput('release_name', picked.name || `Release ${tag}`);
            core.setOutput('release_body', picked.body || '');

      - name: Delete existing release assets for this tag
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');
            let release;
            try {
              const res = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag
              });
              release = res.data;
            } catch (error) {
              core.info(`No existing release for tag ${tag}: ${error.message}`);
              return;
            }

            for (const asset of release.assets || []) {
              core.info(`Deleting old asset: ${asset.name}`);
              await github.rest.repos.deleteReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                asset_id: asset.id
              });
            }

      - name: Publish GitHub Release (from release-drafter)
        if: steps.drafter_notes.outputs.has_draft == 'true'
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.drafter_notes.outputs.release_name }}
          body: ${{ steps.drafter_notes.outputs.release_body }}
          generate_release_notes: false
          overwrite_files: false
          files: release-files/*

      - name: Publish GitHub Release (auto notes fallback)
        if: steps.drafter_notes.outputs.has_draft != 'true'
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.drafter_notes.outputs.release_name }}
          generate_release_notes: true
          overwrite_files: false
          files: release-files/*
